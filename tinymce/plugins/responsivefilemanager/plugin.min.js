/**
 * plugin.js
 *
 * Copyright, Alberto Peripolli
 * Released under Creative Commons Attribution-NonCommercial 3.0 Unported License.
 *
 * Contributing: https://github.com/trippo/ResponsiveFilemanager
 */

// Global state for ResponsiveFilemanager - shared across all editor instances
(function() {
    if (window._rfmInitialized) return;
    window._rfmInitialized = true;

    window._rfmCurrentCallback = null;
    window._rfmCurrentDialogApi = null;

    // Global message handler
    window.addEventListener('message', function(event) {
        if (event.data && event.data.sender === 'responsivefilemanager') {
            var url = event.data.url;

            // Convert absolute URL to relative (remove domain)
            if (url && typeof url === 'string') {
                try {
                    var urlObj = new URL(url, window.location.origin);
                    // If same origin, use only pathname
                    if (urlObj.origin === window.location.origin) {
                        url = urlObj.pathname;
                    }
                } catch (e) {
                    // If URL parsing fails, try simple regex
                    url = url.replace(/^https?:\/\/[^\/]+/, '');
                }
            }

            if (typeof window._rfmCurrentCallback === 'function') {
                window._rfmCurrentCallback(url, { title: '' });
                window._rfmCurrentCallback = null;
            }

            if (window._rfmCurrentDialogApi) {
                window._rfmCurrentDialogApi.close();
                window._rfmCurrentDialogApi = null;
            }
        }
    }, false);
})();

tinymce.PluginManager.add('responsivefilemanager', function (editor) {

    // Register custom options for TinyMCE 8
    const registerOption = editor.options.register;
    registerOption('external_filemanager_path', { processor: 'string', default: '' });
    registerOption('filemanager_title', { processor: 'string', default: 'Soubory' });
    registerOption('filemanager_access_key', { processor: 'string', default: 'key' });
    registerOption('filemanager_sort_by', { processor: 'string', default: '' });
    registerOption('filemanager_descending', { processor: 'string', default: 'false' });
    registerOption('filemanager_subfolder', { processor: 'string', default: '' });
    registerOption('filemanager_crossdomain', { processor: 'boolean', default: false });

    function openmanager(callback, value, meta) {
        let width = window.innerWidth - 20;
        let height = window.innerHeight - 40;
        if (width > 1800) width = 1800;
        if (height > 1200) height = 1200;
        if (width > 600) {
            const width_reduce = (width - 20) % 138;
            width = width - width_reduce + 10;
        }

        editor.focus(true);

        const title = editor.options.get('filemanager_title');
        const akey = editor.options.get('filemanager_access_key');
        const sortBy = editor.options.get('filemanager_sort_by');
        const descending = editor.options.get('filemanager_descending');
        const subfolder = editor.options.get('filemanager_subfolder');
        const crossdomain = editor.options.get('filemanager_crossdomain');
        const externalPath = editor.options.get('external_filemanager_path');
        const lang = editor.options.get('language') || 'en';

        // Build URL parameters
        let urlParams = new URLSearchParams();
        urlParams.set('descending', descending);
        urlParams.set('lang', lang);
        urlParams.set('akey', akey);
        if (sortBy) urlParams.set('sort_by', sortBy);
        if (subfolder) urlParams.set('fldr', subfolder);
        if (crossdomain) urlParams.set('crossdomain', '1');

        // Determine file type: 1=image, 2=file, 3=media
        let urltype = 2;
        if (meta) {
            if (meta.filetype === 'image' || meta.mediaType === 'image') urltype = 1;
            if (meta.filetype === 'media' || meta.mediaType === 'media') urltype = 3;
        }
        urlParams.set('type', urltype);

        const fileUrl = externalPath + 'dialog.php?' + urlParams.toString();

        // Store callback for global message handler
        window._rfmCurrentCallback = callback;

        // Open dialog and store reference globally
        window._rfmCurrentDialogApi = editor.windowManager.openUrl({
            title: title,
            url: fileUrl,
            width: width,
            height: height,
            onClose: function() {
                window._rfmCurrentDialogApi = null;
                window._rfmCurrentCallback = null;
            }
        });
    }

    // Expose openmanager globally so it can be used in TinyMCE init
    window.tinymceResponsiveFileManager = window.tinymceResponsiveFileManager || {};
    window.tinymceResponsiveFileManager[editor.id] = openmanager;

    // Also expose a generic version that finds the active editor
    if (!window.tinymceRFMFilePicker) {
        window.tinymceRFMFilePicker = function(callback, value, meta) {
            const activeEditor = tinymce.activeEditor;
            if (activeEditor && window.tinymceResponsiveFileManager[activeEditor.id]) {
                window.tinymceResponsiveFileManager[activeEditor.id](callback, value, meta);
            }
        };
    }

    // Register toolbar button
    editor.ui.registry.addButton('responsivefilemanager', {
        icon: 'browse',
        tooltip: 'File manager',
        onAction: function() {
            openmanager(function(url) {
                editor.insertContent('<img src="' + url + '" />');
            }, '', { filetype: 'image' });
        }
    });

    // Register menu item
    editor.ui.registry.addMenuItem('responsivefilemanager', {
        icon: 'browse',
        text: 'File manager',
        onAction: function() {
            openmanager(function(url) {
                editor.insertContent('<img src="' + url + '" />');
            }, '', { filetype: 'image' });
        }
    });

    return {
        getMetadata: function() {
            return {
                name: 'Responsive File Manager',
                url: 'https://www.responsivefilemanager.com/'
            };
        }
    };
});